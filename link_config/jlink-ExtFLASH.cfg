source [find interface/jlink.cfg]

transport select swd

# increase working area to 96KB
set WORKAREASIZE 0x18000

# enable stmqspi
set QUADSPI 1

source [find target/stm32h7x.cfg]

# QUADSPI initialization
proc qspi_init { } {
	global a
    #RCC_AHB4ENR GPIOA-GPIOK
	mmw 0x580244E0 0x000007FF 0
    #RCC_AHB3ENR QSPI
	mmw 0x580244D4 0x00004000 0
    #等待
	sleep 1

    #PB3-AF9 PB6-AF10 PD11-AF9 PD12-AF9 PD13-AF9
    #PE2-AF9

	#GPIO模式设置
	mmw 0x58020400 0x00002080 0x00001040
	mmw 0x58020C00 0x0A800000 0x05400000
	mmw 0x58021000 0x00000020 0x00000010
	#GPIO输出速度
	mmw 0x58020408 0x000030C0 0x00000000
	mmw 0x58020C08 0x0FC00000 0x00000000
	mmw 0x58021000 0x00000030 0x00000000
	#GPIO复用功能
	mmw 0x58020420 0x0A009000 0x05006000
	mmw 0x58020C24 0x00999000 0x00666000
	mmw 0x58021020 0x00000900 0x00000600

	#QSPI
	mww 0x52005030 0x00001000
	mww 0x52005000 0x01500008
	mww 0x52005004 0x00170100
	mmw 0x52005000 0x00000001 0

	mww 0x52005014 0x0D002503
}

$_CHIPNAME.cpu0 configure -event reset-init {
	mmw 0x40022000 0x00000004 0x00000003
	sleep 1
	#CR
	mmw 0x58024400 0x00000001 0x00000000
	#PLLCFGR
	mww 0x5802442c 0x01FF0009
	#CFGR
	mww 0x58024410 0x00000019
	#CR enPLLON
	mmw 0x58024400 0x01000000 0x00000000
	sleep 1
	#CFGR
	mmw 0x58024410 0x0000001B 0x00000000
	sleep 1

	adapter speed 2000

	qspi_init
}